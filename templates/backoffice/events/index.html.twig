{% extends 'base.html.twig' %}

{% block title %}Events verwalten - {{ parent() }}{% endblock %}

{% block body %}
    <div class="row">
        <div class="col-12">
            <div class="d-flex justify-content-between align-items-center mb-4">
                <div>
                    <h1 class="h2 mb-0">Event-Management</h1>
                    <small class="text-muted">Verwaltung aller Events und deren Lebenszyklus</small>
                </div>
                <div>
                    <a href="{{ path('backoffice_dashboard') }}" class="btn btn-outline-secondary me-2">
                        <i class="bi bi-arrow-left"></i> Dashboard
                    </a>
                    <a href="{{ path('backoffice_events_create') }}" class="btn btn-primary">
                        <i class="bi bi-plus-circle"></i> Neues Event
                    </a>
                </div>
            </div>
        </div>
    </div>

    <!-- Stats Cards -->
    <div class="row mb-4">
        <div class="col-md-2 mb-3">
            <div class="card text-white bg-info">
                <div class="card-body text-center">
                    <h5 class="card-title mb-1">Gesamt</h5>
                    <h3 class="mb-0">{{ stats.total }}</h3>
                </div>
            </div>
        </div>
        <div class="col-md-2 mb-3">
            <div class="card text-white bg-secondary">
                <div class="card-body text-center">
                    <h5 class="card-title mb-1">Entwurf</h5>
                    <h3 class="mb-0">{{ stats.draft }}</h3>
                </div>
            </div>
        </div>
        <div class="col-md-2 mb-3">
            <div class="card text-white bg-success">
                <div class="card-body text-center">
                    <h5 class="card-title mb-1">Aktiv</h5>
                    <h3 class="mb-0">{{ stats.active }}</h3>
                </div>
            </div>
        </div>
        <div class="col-md-2 mb-3">
            <div class="card text-white bg-warning">
                <div class="card-body text-center">
                    <h5 class="card-title mb-1">Geschlossen</h5>
                    <h3 class="mb-0">{{ stats.closed }}</h3>
                </div>
            </div>
        </div>
        <div class="col-md-2 mb-3">
            <div class="card text-white bg-dark">
                <div class="card-body text-center">
                    <h5 class="card-title mb-1">Archiviert</h5>
                    <h3 class="mb-0">{{ stats.archived }}</h3>
                </div>
            </div>
        </div>
    </div>

    <!-- Filter Tabs -->
    <div class="row">
        <div class="col-12">
            <div class="card">
                <div class="card-header">
                    <ul class="nav nav-tabs card-header-tabs" role="tablist">
                        <li class="nav-item" role="presentation">
                            <a class="nav-link {{ currentStatus is null ? 'active' : '' }}" 
                               href="{{ path('backoffice_events_index') }}">
                                <i class="bi bi-list me-2"></i>
                                Alle Events ({{ stats.total }})
                            </a>
                        </li>
                        <li class="nav-item" role="presentation">
                            <a class="nav-link {{ currentStatus and currentStatus.value == 'draft' ? 'active' : '' }}" 
                               href="{{ path('backoffice_events_index', {status: 'draft'}) }}">
                                <i class="bi bi-file-earmark me-2"></i>
                                Entwürfe ({{ stats.draft }})
                            </a>
                        </li>
                        <li class="nav-item" role="presentation">
                            <a class="nav-link {{ currentStatus and currentStatus.value == 'active' ? 'active' : '' }}" 
                               href="{{ path('backoffice_events_index', {status: 'active'}) }}">
                                <i class="bi bi-play-circle me-2"></i>
                                Aktiv ({{ stats.active }})
                            </a>
                        </li>
                        <li class="nav-item" role="presentation">
                            <a class="nav-link {{ currentStatus and currentStatus.value == 'closed' ? 'active' : '' }}" 
                               href="{{ path('backoffice_events_index', {status: 'closed'}) }}">
                                <i class="bi bi-stop-circle me-2"></i>
                                Geschlossen ({{ stats.closed }})
                            </a>
                        </li>
                        <li class="nav-item" role="presentation">
                            <a class="nav-link {{ currentStatus and currentStatus.value == 'archived' ? 'active' : '' }}" 
                               href="{{ path('backoffice_events_index', {status: 'archived'}) }}">
                                <i class="bi bi-archive me-2"></i>
                                Archiviert ({{ stats.archived }})
                            </a>
                        </li>
                    </ul>
                </div>
                <div class="card-body">
                    {% if events is empty %}
                        <div class="text-center py-5">
                            <i class="bi bi-calendar-x" style="font-size: 4rem; color: #dee2e6;"></i>
                            <h3 class="text-muted mt-3">Keine Events</h3>
                            <p class="text-muted">
                                {% if currentStatus %}
                                    Keine Events mit Status "{{ currentStatus.value }}" gefunden.
                                {% else %}
                                    Noch keine Events erstellt.
                                {% endif %}
                            </p>
                            <a href="{{ path('backoffice_events_create') }}" class="btn btn-primary">
                                <i class="bi bi-plus-circle me-2"></i>Erstes Event erstellen
                            </a>
                        </div>
                    {% else %}
                        <!-- Bulk Actions -->
                        <div class="d-flex justify-content-between align-items-center mb-3">
                            <div>
                                <button type="button" id="selectAllBtn" class="btn btn-outline-secondary btn-sm">
                                    <i class="fas fa-check-square"></i> Alle auswählen
                                </button>
                                <button type="button" id="deselectAllBtn" class="btn btn-outline-secondary btn-sm" style="display: none;">
                                    <i class="fas fa-square"></i> Auswahl aufheben
                                </button>
                            </div>
                            
                            <div id="bulkActionsBar" style="display: none;">
                                <span id="selectedCount" class="me-3 text-muted">0 Events ausgewählt</span>
                                <div class="btn-group" role="group">
                                    <button type="button" class="btn btn-success btn-sm" data-action="activate">
                                        <i class="fas fa-play"></i> Aktivieren
                                    </button>
                                    <button type="button" class="btn btn-warning btn-sm" data-action="close">
                                        <i class="fas fa-stop"></i> Schließen
                                    </button>
                                    <button type="button" class="btn btn-secondary btn-sm" data-action="archive">
                                        <i class="fas fa-archive"></i> Archivieren
                                    </button>
                                    <button type="button" class="btn btn-danger btn-sm" data-action="delete" 
                                            onclick="return confirm('Ausgewählte Events wirklich löschen? Diese Aktion kann nicht rückgängig gemacht werden.')">
                                        <i class="fas fa-trash"></i> Löschen
                                    </button>
                                </div>
                            </div>
                        </div>
                        
                        <div class="row">
                            {% for event in events %}
                                <div class="col-lg-6 mb-4">
                                    <div class="card h-100">
                                        <div class="card-body">
                                            <div class="d-flex justify-content-between align-items-start mb-3">
                                                <div>
                                                    {% set statusColor = event.status.value == 'draft' ? 'secondary' : 
                                                                        (event.status.value == 'active' ? 'success' : 
                                                                        (event.status.value == 'closed' ? 'warning' : 'dark')) %}
                                                    <span class="badge bg-{{ statusColor }} mb-2">
                                                        {% if event.status.value == 'draft' %}
                                                            <i class="bi bi-file-earmark"></i> Entwurf
                                                        {% elseif event.status.value == 'active' %}
                                                            <i class="bi bi-play-circle"></i> Aktiv
                                                        {% elseif event.status.value == 'closed' %}
                                                            <i class="bi bi-stop-circle"></i> Geschlossen
                                                        {% else %}
                                                            <i class="bi bi-archive"></i> Archiviert
                                                        {% endif %}
                                                    </span>
                                                </div>
                                                <div class="d-flex align-items-center">
                                                    <div class="form-check me-2">
                                                        <input class="form-check-input event-checkbox" 
                                                               type="checkbox" 
                                                               value="{{ event.id }}" 
                                                               id="event_{{ event.id }}">
                                                        <label class="form-check-label" for="event_{{ event.id }}"></label>
                                                    </div>
                                                    <small class="text-muted">{{ event.createdAt|date('d.m.Y') }}</small>
                                                </div>
                                            </div>
                                            
                                            <h5 class="card-title">{{ event.name }}</h5>
                                            
                                            {% if event.description %}
                                                <p class="card-text text-muted">{{ event.description|u.truncate(100) }}</p>
                                            {% endif %}
                                            
                                            <div class="row text-center mb-3">
                                                {% if event.eventDate %}
                                                    <div class="col">
                                                        <small class="text-muted">
                                                            <i class="bi bi-calendar3"></i><br>
                                                            {{ event.eventDate|date('d.m.Y') }}
                                                        </small>
                                                    </div>
                                                {% endif %}
                                                {% if event.location %}
                                                    <div class="col">
                                                        <small class="text-muted">
                                                            <i class="bi bi-geo-alt"></i><br>
                                                            {{ event.location|u.truncate(15) }}
                                                        </small>
                                                    </div>
                                                {% endif %}
                                                <div class="col">
                                                    <small class="text-muted">
                                                        <i class="bi bi-link-45deg"></i><br>
                                                        <code>{{ event.slug }}</code>
                                                    </small>
                                                </div>
                                            </div>
                                        </div>
                                        
                                        <div class="card-footer bg-light">
                                            <div class="d-flex justify-content-between align-items-center">
                                                <small class="text-muted">
                                                    ID: #{{ event.id }}
                                                </small>
                                                <div class="d-flex gap-1">
                                                    <a href="{{ path('backoffice_events_detail', {slug: event.slug}) }}" 
                                                       class="btn btn-outline-primary btn-sm">
                                                        <i class="bi bi-eye"></i> Details
                                                    </a>
                                                    {% if event.isPubliclyVisible() %}
                                                        <a href="{{ path('event_show', {slug: event.slug}) }}" 
                                                           class="btn btn-outline-success btn-sm"
                                                           target="_blank">
                                                            <i class="bi bi-box-arrow-up-right"></i>
                                                        </a>
                                                    {% endif %}
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            {% endfor %}
                        </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
{% endblock %}

{% block javascripts %}
{{ parent() }}
<script>
document.addEventListener('DOMContentLoaded', function() {
    const eventCheckboxes = document.querySelectorAll('.event-checkbox');
    const selectAllBtn = document.getElementById('selectAllBtn');
    const deselectAllBtn = document.getElementById('deselectAllBtn');
    const bulkActionsBar = document.getElementById('bulkActionsBar');
    const selectedCount = document.getElementById('selectedCount');
    const bulkActionBtns = document.querySelectorAll('[data-action]');
    
    // Update UI based on selection
    function updateBulkActionsUI() {
        const checkedBoxes = document.querySelectorAll('.event-checkbox:checked');
        const count = checkedBoxes.length;
        
        if (count > 0) {
            bulkActionsBar.style.display = 'block';
            selectedCount.textContent = `${count} Event${count > 1 ? 's' : ''} ausgewählt`;
            selectAllBtn.style.display = count === eventCheckboxes.length ? 'none' : 'inline-block';
            deselectAllBtn.style.display = 'inline-block';
        } else {
            bulkActionsBar.style.display = 'none';
            selectAllBtn.style.display = 'inline-block';
            deselectAllBtn.style.display = 'none';
        }
    }
    
    // Select all events
    selectAllBtn.addEventListener('click', function() {
        eventCheckboxes.forEach(checkbox => checkbox.checked = true);
        updateBulkActionsUI();
    });
    
    // Deselect all events
    deselectAllBtn.addEventListener('click', function() {
        eventCheckboxes.forEach(checkbox => checkbox.checked = false);
        updateBulkActionsUI();
    });
    
    // Individual checkbox change
    eventCheckboxes.forEach(checkbox => {
        checkbox.addEventListener('change', updateBulkActionsUI);
    });
    
    // Bulk action buttons
    bulkActionBtns.forEach(btn => {
        btn.addEventListener('click', function() {
            const action = this.dataset.action;
            const checkedBoxes = document.querySelectorAll('.event-checkbox:checked');
            const eventIds = Array.from(checkedBoxes).map(cb => cb.value);
            
            if (eventIds.length === 0) {
                alert('Keine Events ausgewählt.');
                return;
            }
            
            // Additional confirmation for destructive actions
            if (action === 'delete') {
                const confirmMessage = `Möchten Sie wirklich ${eventIds.length} Event(s) löschen? Diese Aktion kann nicht rückgängig gemacht werden.`;
                if (!confirm(confirmMessage)) {
                    return;
                }
            }
            
            // Disable button during request
            this.disabled = true;
            const originalText = this.innerHTML;
            this.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Verarbeite...';
            
            // Prepare form data
            const formData = new FormData();
            formData.append('action', action);
            formData.append('_token', '{{ csrf_token('bulk_actions') }}');
            eventIds.forEach(id => formData.append('eventIds[]', id));
            
            // Send request
            fetch('{{ path('backoffice_events_bulk_actions') }}', {
                method: 'POST',
                body: formData,
                headers: {
                    'X-Requested-With': 'XMLHttpRequest'
                }
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    // Show success message
                    showNotification(data.message, 'success');
                    
                    // Reload page to reflect changes
                    setTimeout(() => {
                        window.location.reload();
                    }, 1500);
                } else {
                    showNotification(data.message || 'Ein Fehler ist aufgetreten.', 'error');
                }
            })
            .catch(error => {
                console.error('Error:', error);
                showNotification('Netzwerkfehler beim Verarbeiten der Anfrage.', 'error');
            })
            .finally(() => {
                // Re-enable button
                this.disabled = false;
                this.innerHTML = originalText;
            });
        });
    });
    
    // Simple notification system
    function showNotification(message, type) {
        const alertClass = type === 'success' ? 'alert-success' : 'alert-danger';
        const alertHtml = `
            <div class="alert ${alertClass} alert-dismissible fade show" role="alert">
                ${message}
                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            </div>
        `;
        
        const container = document.querySelector('.container-fluid');
        const firstChild = container.firstElementChild;
        firstChild.insertAdjacentHTML('afterend', alertHtml);
    }
});
</script>
{% endblock %}